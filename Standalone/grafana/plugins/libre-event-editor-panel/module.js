/*! For license information please see module.js.LICENSE.txt */
define(["react","@grafana/ui","@grafana/data","@grafana/runtime"],(function(e,t,n,a){return function(e){var t={};function n(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(a,r,function(t){return e[t]}.bind(null,r));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=4)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t,n){"use strict";n.r(t);var a=n(2),r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function l(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var a,r,l=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(a=l.next()).done;)i.push(a.value)}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}return i}var i=n(0),o=n.n(i),u=n(3),c=n(1);function s(e){var t=e.startDateTime,n=e.endDateTime,r=e.onAfterChange,u=l(Object(i.useState)(t),2),s=u[0],d=u[1],m=t.valueOf(),f=n.valueOf(),v=Math.floor((f-m)/6e4);return o.a.createElement("div",null,o.a.createElement("h3",null," Split Event by Time "),o.a.createElement("div",null,"Selected Time: ",o.a.createElement("b",null,s&&s.toLocaleString())," "),o.a.createElement("div",null,o.a.createElement(c.Slider,{step:1,value:[0],min:0,max:v,tooltipAlwaysVisible:!0,onChange:function(e){d(Object(a.dateTimeAsMoment)(t).add(e,"minute").toDate())},onAfterChange:function(e){r(s)}})),o.a.createElement(c.HorizontalGroup,null,o.a.createElement("div",null," ","Start Time: ",o.a.createElement("b",null,t.toLocaleString())," "),o.a.createElement("div",null," ","End Time: ",o.a.createElement("b",null,n.toLocaleString()))))}var d=function e(t){var n=t.reasons,a=t.onFinalReasonSelection,r=t.parentReason,u=function(e,t){return void 0===t?e.filter((function(e,t,n){return null===e.parent})):e.filter((function(e,n,a){return e.parent===t.id}))}(n,r),s=l(Object(i.useState)(),2),d=s[0],m=s[1];return u.length<1?(a(r),null):(a(void 0),o.a.createElement(c.VerticalGroup,null,o.a.createElement("div",null,o.a.createElement(c.HorizontalGroup,{spacing:"lg"},n.length>0&&u.map((function(e){return o.a.createElement(c.Button,{key:e.id,variant:e.id!==(null==d?void 0:d.id)?"primary":"destructive",size:"sm",onClick:function(){e===d?(m(void 0),a(void 0)):m(e)}},e.text)})))),o.a.createElement("div",null,d&&o.a.createElement(e,{reasons:n,parentReason:d,onFinalReasonSelection:a}))))};function m(e){var t=e.machineEvent,n=e.equipment,a=e.title,r=e.reasons,u=e.dismissModal,m=e.onAssignReason,f=e.onSplitEvent,v=e.onEditComment,p=l(Object(i.useState)(void 0),2),E=p[0],g=p[1],h=l(Object(i.useState)(void 0),2),y=h[0],T=h[1],M=l(Object(i.useState)(t.comment?t.comment:""),2),b=M[0],S=M[1],D=(null==t?void 0:t.endDateTime)?new Date(t.endDateTime):new Date,C=new Date(t.startDateTime);return o.a.createElement(c.Modal,{isOpen:!!t,title:a,onDismiss:u,onClickBackdrop:u},o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("h3",null," Edit Event Comment "),o.a.createElement("div",null,o.a.createElement(c.TextArea,{css:{},invalid:!1,placeholder:"Type your comment here",disabled:!1,value:b,onChange:function(e){return S(e.target.value)}})),o.a.createElement("div",null,o.a.createElement(c.Button,{onClick:function(){return v(n,t,b)}},"Edit Comment"))),o.a.createElement("hr",null),o.a.createElement("div",null,o.a.createElement(c.VerticalGroup,null,o.a.createElement("h3",null," Assign Reason to Event "),o.a.createElement("div",null,o.a.createElement(d,{reasons:r,onFinalReasonSelection:function(e){console.log(E),g(e)}})),o.a.createElement("div",null,E&&o.a.createElement(c.HorizontalGroup,null,o.a.createElement(c.Button,{size:"md",onClick:function(){m(n,t,E)}},"Assign Reason"))))),o.a.createElement("hr",null),o.a.createElement("div",null,o.a.createElement(s,{startDateTime:new Date(C),endDateTime:D,onAfterChange:T}),o.a.createElement("div",null,o.a.createElement("div",null,y&&o.a.createElement(c.Button,{onClick:function(){f(n,t,y)}}," ","Split Event"," "))))))}var f=a.AppEvents.alertError,v=a.AppEvents.alertSuccess;!function(e){function t(){return null!==e&&e.apply(this,arguments)||this}(function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)})(t,e),t.type="refresh"}(a.BusEventBase);var p=function(e){var t={id:""};if(!e)return t;var n=e.fields.find((function(e){return"id"===e.name}));return n&&(t.id=n.values.get(n.values.length-1)),t},E=function(e){if(!e)return[];for(var t=e.fields.find((function(e){return"packMLStatus"===e.name})),n=e.fields.find((function(e){return"startDateTime"===e.name})),a=e.fields.find((function(e){return"endDateTime"===e.name})),r=e.fields.find((function(e){return"duration"===e.name})),l=e.fields.find((function(e){return"reasonCategoryCode"===e.name})),i=e.fields.find((function(e){return"reasonCode"===e.name})),o=e.fields.find((function(e){return"reasonText"===e.name})),u=e.fields.find((function(e){return"comments"===e.name})),c=[],s=0;s<e.length;s++)c.push({packMLStatus:null==t?void 0:t.values.get(s),startDateTime:null==n?void 0:n.values.get(s),endDateTime:null==a?void 0:a.values.get(s),duration:null==r?void 0:r.values.get(s),timeType:null==l?void 0:l.values.get(s),category:null==i?void 0:i.values.get(s),reason:null==o?void 0:o.values.get(s),comment:null==u?void 0:u.values.get(s)});return c},g=function(e){if(!e)return[];for(var t=e.fields.find((function(e){return"id"===e.name})),n=e.fields.find((function(e){return"isActaive"===e.name})),a=e.fields.find((function(e){return"class"===e.name})),r=e.fields.find((function(e){return"label"===e.name})),l=e.fields.find((function(e){return"text"===e.name})),i=e.fields.find((function(e){return"parent"===e.name})),o=e.fields.find((function(e){return"standardValue"===e.name})),u=e.fields.find((function(e){return"category.code"===e.name})),c=[],s=0;s<e.length;s++)c.push({id:null==t?void 0:t.values.get(s),isActive:null==n?void 0:n.values.get(s),class:null==a?void 0:a.values.get(s),label:null==r?void 0:r.values.get(s),text:null==l?void 0:l.values.get(s),parent:null==i?void 0:i.values.get(s),standardValue:null==o?void 0:o.values.get(s),categoryCode:null==u?void 0:u.values.get(s)});return c},h=function(e){if(!e)return[];for(var t=e.fields.find((function(e){return"id"===e.name})),n=e.fields.find((function(e){return"isActaive"===e.name})),a=e.fields.find((function(e){return"class"===e.name})),r=e.fields.find((function(e){return"label"===e.name})),l=e.fields.find((function(e){return"text"===e.name})),i=e.fields.find((function(e){return"parent.id"===e.name})),o=e.fields.find((function(e){return"standardValue"===e.name})),u=e.fields.find((function(e){return"category.code"===e.name})),c=[],s=0;s<e.length;s++)c.push({id:null==t?void 0:t.values.get(s),isActive:null==n?void 0:n.values.get(s),class:null==a?void 0:a.values.get(s),label:null==r?void 0:r.values.get(s),text:null==l?void 0:l.values.get(s),parent:null==i?void 0:i.values.get(s),standardValue:null==o?void 0:o.values.get(s),categoryCode:null==u?void 0:u.values.get(s)});return c},y=function(e){return{equipment:p(e.series[0]),events:E(e.series[1]),reasons:g(e.series[2]),reasonsWithParents:h(e.series[3])}};n.d(t,"plugin",(function(){return T}));var T=new a.PanelPlugin((function(e){var t=l(Object(i.useState)(null),2),n=t[0],r=t[1],s=Object(c.useTheme)(),d=function(t){var n,a=null===(n=e.data.request)||void 0===n?void 0:n.targets.find((function(t){return t.refId===e.options.eventMetric}));a?Object(u.getDataSourceSrv)().get(a.datasource).then((function(e){try{e.request(t).then((function(e){200===(null==e?void 0:e.status)&&(console.log(e),p(v,"Event Updated"),E(),g())}))}catch(e){p(f,"Failed to Update: "+e)}})).catch((function(t){p(f,"Failed to find Event Metric '"+e.options.eventMetric+"': "+t)})):p(f,"Failed to find Event Metric '"+e.options.eventMetric+"'")},p=function(e,t){u.SystemJS.load("app/core/app_events").then((function(n){n.emit(e,[t])}))},E=function(){var e=document.getElementsByClassName("refresh-picker");if(e.length>0){var t=e[0].getElementsByClassName("toolbar-button");if(t.length>0)t[0].click()}},g=function(){r(null)},h=e.width,T=y(e.data),M=T.reasons,b=T.equipment,S=T.reasonsWithParents,D=T.events,C=null==D?void 0:D.length,O=null==M?void 0:M.length;return C&&O?o.a.createElement("div",null,n?o.a.createElement(m,{machineEvent:n,equipment:b,title:"Event Log Editor",reasons:M.concat(S),dismissModal:g,onAssignReason:function(e,t,n){var r='\n    mutation\n      {\n        updateEventLogTS(input:[{eventStartTime:"'+Object(a.dateTimeAsMoment)(t.startDateTime).utc().format()+'",equipment:{id:"'+e.id+'"}, reasonText: "'+n.text+'", reasonCategoryCode:"'+n.categoryCode+'"}]){\n          equipment{id}\n          eventTime\n          reasonCategoryCode\n          reasonCode\n          reasonText\n          PackMLStatus\n          reasonValue\n          reasonValueUoM\n          comment\n          previousTime\n        }\n      }\n    ';d(r)},onSplitEvent:function(e,t,n){var r=Object(a.dateTimeAsMoment)(t.startDateTime).format("YYYY-MM-DDTHH:mm:ssZ"),l=Object(a.dateTimeAsMoment)(n).format("YYYY-MM-DDTHH:mm:ssZ"),i='mutation{\n      splitEventLogTS(input:[{eventStartTime:"'+r+'", packMLStatus:"'+t.packMLStatus+'", equipment: {id:"'+e.id+'"}},{eventStartTime:"'+l+'", packMLStatus:"'+t.packMLStatus+'", equipment: {id:"'+e.id+'"}}]){\n        eventTime\n      }\n    }';d(i)},onEditComment:function(e,t,n){var a='\n    mutation\n      {\n        updateEventLogTS(input:[{eventStartTime:"'+t.startDateTime+'",equipment:{id:"'+e.id+'"}, comment: "'+n+'"}]){\n          equipment{id}\n          eventTime\n          reasonCategoryCode\n          reasonCode\n          reasonText\n          PackMLStatus\n          reasonValue\n          reasonValueUoM\n          comment\n          previousTime\n        }\n      }\n    ';d(a)}}):o.a.createElement(o.a.Fragment,null),o.a.createElement("table",{width:h},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"Start"),o.a.createElement("th",null,"End"),o.a.createElement("th",null,"Duration"),o.a.createElement("th",null,"Time Category"),o.a.createElement("th",null,"Reason"),o.a.createElement("th",null,"Comment"))),o.a.createElement("tbody",null,D.length>0&&D.map((function(t){return o.a.createElement("tr",{onClick:function(n){return function(t,n){var a=y(e.data).reasons;a&&a.length>0&&r(n)}(0,t)},onMouseOver:function(e){return function(e,t){e.target.parentElement.style.background=s.palette.gray95,e.target.parentElement.style.color=s.palette.black}(e)},onMouseLeave:function(e){return function(e){e.target.parentElement.style.background=null,e.target.parentElement.style.color=null}(e)},key:t.startDateTime},o.a.createElement("td",null,Object(a.dateTimeAsMoment)(t.startDateTime).format("YYYY-MM-DD[, ]HH:mm:ss")),o.a.createElement("td",null,t.endDateTime&&Object(a.dateTimeAsMoment)(t.endDateTime).format("YYYY-MM-DD[, ]HH:mm:ss")),o.a.createElement("td",null,(n=t.duration,l=Math.floor(n/86400),i=Math.floor((n-24*l*3600)/3600),u=Math.floor((n-24*l*3600-60*i*60)/60),c=Math.floor(n-24*l*3600-60*i*60-60*u),(l?l+" Days ":"")+(i?i+" Hours ":"")+(u?u+" Minutes ":"")+(c?c+" Seconds ":""))),o.a.createElement("td",null,t.timeType),o.a.createElement("td",null,t.reason),o.a.createElement("td",null,t.comment));var n,l,i,u,c}))))):o.a.createElement("div",null,"No data")})).setNoPadding().setPanelOptions((function(e){e.addTextInput({path:"eventMetric",name:"Event Metric",description:"Name of Query Metric with Event Data",defaultValue:"Events"}).addTextInput({path:"reasonMetric",name:"Reason Metric",description:"Name of Query Metric with Reason Data",defaultValue:"Reasons"})}))}])}));
//# sourceMappingURL=module.js.map